name: Check Stepifi Version

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest Stepifi release
        id: get-latest-release
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/voron69-bit/Stepifi/tags | jq -r '.[0].name')
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Get current chart appVersion
        id: get-current-version
        run: |
          CURRENT_VERSION=$(grep 'appVersion:' charts/stepifi/Chart.yaml | awk '{print $2}' | tr -d '"')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Update chart if version changed
        if: steps.get-latest-release.outputs.latest_version != steps.get-current-version.outputs.current_version
        id: update-chart
        run: |
          LATEST="${{ steps.get-latest-release.outputs.latest_version }}"
          # Remove 'v' prefix if present
          VERSION_NO_V="${LATEST#v}"

          # Get current chart version
          CURRENT_CHART_VERSION=$(grep '^version:' charts/stepifi/Chart.yaml | awk '{print $2}')
          
          # Increment patch version
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_CHART_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          NEW_PATCH=$((PATCH + 1))
          NEW_CHART_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

          # Update Chart Version
          sed -i "s/^version: .*/version: $NEW_CHART_VERSION/" charts/stepifi/Chart.yaml

          # Update appVersion
          sed -i "s/^appVersion: .*/appVersion: \"$VERSION_NO_V\"/" charts/stepifi/Chart.yaml

          echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.get-latest-release.outputs.latest_version != steps.get-current-version.outputs.current_version
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(stepifi): bump appVersion to ${{ steps.update-chart.outputs.version_no_v }}"
          branch: chore/stepifi-version-bump
          delete-branch: true
          title: "chore(stepifi): bump appVersion to ${{ steps.update-chart.outputs.version_no_v }}"
          body: |
            Bumps Stepifi appVersion to `${{ steps.update-chart.outputs.version_no_v }}`.
            
            Upstream Release: https://github.com/voron69-bit/Stepifi/releases/tag/${{ steps.get-latest-release.outputs.latest_version }}
          labels: |
            automation
            dependencies
