name: Check BentoPDF Version

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest BentoPDF release
        id: get-latest-release
        run: |
          # Use GitHub API to get the latest release tag
          # Assuming the repo is alam00000/bentopdf
          LATEST_VERSION=$(curl -s https://api.github.com/repos/alam00000/bentopdf/tags | jq -r '.[0].name')
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Get current chart appVersion
        id: get-current-version
        run: |
          CURRENT_VERSION=$(grep 'appVersion:' charts/bentopdf/Chart.yaml | awk '{print $2}' | tr -d '"')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Update chart if version changed
        if: steps.get-latest-release.outputs.latest_version != steps.get-current-version.outputs.current_version
        id: update-chart
        run: |
          LATEST="${{ steps.get-latest-release.outputs.latest_version }}"
          # Remove 'v' prefix if present depending on how the tag is formatted. 
          # The current chart version is 1.16.0 without v. Tags might have v.
          VERSION_NO_V="${LATEST#v}"

          # Update Version to match AppVersion exactly (or bump patch/minor as needed)
          sed -i "s/^version: .*/version: $VERSION_NO_V/" charts/bentopdf/Chart.yaml

          # Update appVersion
          sed -i "s/^appVersion: .*/appVersion: \"$VERSION_NO_V\"/" charts/bentopdf/Chart.yaml

          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
          echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.get-latest-release.outputs.latest_version != steps.get-current-version.outputs.current_version
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(bentopdf): bump appVersion to ${{ steps.update-chart.outputs.version_no_v }}"
          branch: chore/bentopdf-version-bump-${{ steps.update-chart.outputs.version_no_v }}
          delete-branch: true
          title: "chore(bentopdf): bump appVersion to ${{ steps.update-chart.outputs.version_no_v }}"
          body: |
            Bumps BentoPDF appVersion to `${{ steps.update-chart.outputs.version_no_v }}`.
            
            Upstream Release: https://github.com/alam00000/bentopdf/tags
            (Exact release link might vary as tags are used)
          labels: |
            automation
            dependencies
