name: Check Mealie Version

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest Mealie release
        id: get-latest-release
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/mealie-recipes/mealie/releases/latest | jq -r .tag_name)
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Get current chart appVersion
        id: get-current-version
        run: |
          CURRENT_VERSION=$(grep 'appVersion:' charts/mealie/Chart.yaml | awk '{print $2}' | tr -d '"')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Update chart if version changed
        if: steps.get-latest-release.outputs.latest_version != steps.get-current-version.outputs.current_version
        run: |
          LATEST="${{ steps.get-latest-release.outputs.latest_version }}"
          # Remove 'v' prefix for Chart version
          VERSION_NO_V="${LATEST#v}"

          # Get current chart version
          CURRENT_CHART_VERSION=$(grep '^version:' charts/mealie/Chart.yaml | awk '{print $2}')

          # Increment patch version
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_CHART_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          NEW_PATCH=$((PATCH + 1))
          NEW_CHART_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

          # Update Chart Version
          sed -i "s/^version: .*/version: $NEW_CHART_VERSION/" charts/mealie/Chart.yaml

          # Update appVersion
          sed -i "s/^appVersion: .*/appVersion: \"$LATEST\"/" charts/mealie/Chart.yaml

          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
          echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.get-latest-release.outputs.latest_version != steps.get-current-version.outputs.current_version
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(mealie): bump appVersion to ${{ steps.get-latest-release.outputs.latest_version }}"
          branch: chore/mealie-version-bump
          delete-branch: true
          title: "chore(mealie): bump appVersion to ${{ steps.get-latest-release.outputs.latest_version }}"
          body: |
            Bumps Mealie appVersion to `${{ steps.get-latest-release.outputs.latest_version }}`.
            
            Upstream Release: https://github.com/mealie-recipes/mealie/releases/tag/${{ steps.get-latest-release.outputs.latest_version }}
          labels: |
            automation
            dependencies
